{% extends "index.html" %}
{% block content %}

<style>
	html,
	body {
		width : 100%;
		height : 100%;
	}
	#searchResult_box{
		display: grid;
		grid-template-columns : 70% 30%;
	}

	#searchFilter_box {
		display: none;
	}
</style>

<div id="stationSearch_box">
	<label for="station_input">역이름</label>
	<input list="stationList" id="station_input" name="station_input" placeholder="ex) 역삼역(x), 역삼(O)" required>
	<button type="button" onclick="find_station()" >검색</button>
	<input type="button" id="searchFilter_btn" onclick="openclose()" value = "+">
</div>
<div id="searchFilter_box">
	<div class="foodCategory">
		<legend>분류 (select all<input type="checkbox" name="" id="checkAll" checked>)</legend>
		<input type ="checkbox" name ="category" value="rice" checked>밥/국/찌개
		<input type ="checkbox" name ="category" value="meat" checked>고기/육류
		<input type ="checkbox" name ="category" value="noodle" checked>면류<br>
		<input type ="checkbox" name ="category" value="seaFood" checked>해산물
		<input type ="checkbox" name ="category" value="worldFood" checked>세계음식
		<input type ="checkbox" name ="category" value="bread" checked>빵
		<input type ="checkbox" name ="category" value="flourbasedFood" checked>분식
		<input type ="checkbox" name ="category" value="cafeBar" checked>카페/음료/바
	</div>
	<div id="visit">
		<fildset>
			<legend>방문여부</legend>
			<input type="radio" name="visit_record" value="visit_all" checked>
			<label for="visit_all">전체</label>
			<input type="radio" name="visit_record" value="visit_no">
			<label for="visit_no">도전!</label>
			<input type="radio" name="visit_record" value="visit_ok">
			<label for="visit_ok">검완!</label>
		</fildset>
	</div>
</div>

<div id="searchResult_box">
	<div id="map" style="height:540px;"></div>
	<div id ="resultList_box">
		<div class = "name_result">
			<label for ="name_result">상호명</label>
			<input type="text" name = "name_result" id="name_result" >   
		</div>
		<div class = "address_result">
			<label for ="address_result">주소</label>
			<input type = "text" name="address_result" id="address_result" >
		</div>
		<div class = "memo_result">
			<label for ="memo_result">메모</label>
			<input type = "text" name="memo_result" id="memo_result" >
		</div>
		<div class = "blog_result">
			<table border="1">
				<thead>
					<tr>블로그</tr>
				</thead>
				<tbody id = "blog_result">
				</tbody>
			</table>
		</div>
	</div>
</div>


<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=932f62c2719eabbf4e13cd00cd133311&libraries=services"></script>
<script>
	//체크박스 전체 선택하기
	var $checkAll = $('#checkAll');
	$checkAll.change(function () {
		var $this = $(this);
		var checked = $this.prop('checked');
		$('input[name="category"]').prop('checked', checked);
	});

	//체크박스 일부 선택시, 전체선택 해제
	var boxes = $('input[name="category"]');
	boxes.change(function () {
		var boxLength = boxes.length;
		var checkedLength = $('input[name="category"]:checked').length;
		var selectAll = (boxLength == checkedLength);
		$checkAll.prop('checked', selectAll);
	});

	function openclose() {
		if ( $('#searchFilter_box').css('display') == 'block' ) {
			$('#searchFilter_box').hide();
			document.getElementById('searchFilter_btn').value = "+"
		} else {
			$('#searchFilter_box').show();
			document.getElementById('searchFilter_btn').value = "-"
		}
	}



	//지도 띄우기
	var infowindow = new kakao.maps.InfoWindow({zIndex:1});
	var mapContainer = document.getElementById('map'),
	mapOption = {
		center: new kakao.maps.LatLng(37.566826, 126.9786567),
		level: 7
	};  
	var map = new kakao.maps.Map(mapContainer, mapOption); 

	

	markerList = []

	function find_station() {
		checkedList=[]
		check_count = document.getElementsByName("category").length;
		for (i=0; i<check_count; i++) {
			if (document.getElementsByName("category")[i].checked == true) {
				checkedCategory = document.getElementsByName("category")[i].value ;   
				checkedList.push(checkedCategory)
			}
		}

		//객체가 비어있는지 확인
		var isEmpty = function(value){
			if( value == "" || value == null || value == undefined || ( value != null && typeof value == "object" && !Object.keys(value).length ) ){
				return true
			}else{
				return false
			}
		}

		radioVal = $('input[name="visit_record"]:checked').val()
		stationName = $('#station_input').val()
		
		if(stationName == "") {
			alert('역이름을 입력해주세요.')
			$('#station_input').focus();
			return
		}
		else if(isEmpty(checkedList)==true) {
			alert('카테고리를 선택해주세요.')
			return
		}

		$.ajax({
			type: "get",
			url: `/mylist?station_give=${stationName} ${checkedList} ${radioVal}`,  
			data: {},
			success: function(response){
				$('#blog_result').empty()
				document.getElementById('name_result').value = ""
				document.getElementById('address_result').value = ""
				document.getElementById('memo_result').value = ""

				//이전 마커삭제
				if(markerList.length >= 1) {
					for(i=0; i<markerList.length; i++) {
						// markerList[i].setVisible(false)
						markerList[i].setMap(null);
					}
				}

				if (response["result"]=="success") {
					alert("검색완료!");	
					rows = response['store_info']
					for (i=0; i<rows.length; i++) {
						server_name = rows[i]['name']
						server_memo = rows[i]['memo']
						server_address = rows[i]['address']
						server_visit = rows[i]['visit']
						server_food_kind = rows[i]['food_kind']
						server_x_code = rows[i]['x_code']
						server_y_code = rows[i]['y_code']
						server_storeLinkTitle = rows[i]['storeLinkTitle']
						server_storeLinkHref = rows[i]['storeLinkHref']
						displayMarker()   
					}   
				}
			}
		})
	}

	function displayMarker() {
		var storeName = server_name
		var storeAddress = server_address
		var storeMemo = server_memo
		var blogTitle = server_storeLinkTitle
		var blogLink = server_storeLinkHref

		var marker = new kakao.maps.Marker({
			// map: map,
			position: new kakao.maps.LatLng(server_y_code, server_x_code) 
		});

		infowindow.close();
		marker.setMap(map)
		markerList.push(marker)

		kakao.maps.event.addListener(marker, 'click', function() {
			$('#blog_result').empty()
			document.getElementById('name_result').value = ""
			document.getElementById('address_result').value = ""
			document.getElementById('memo_result').value = ""

			infowindow.setContent('<div style="padding:5px;font-size:12px;">' + storeName + '</div>');
			infowindow.open(map, marker);

			for (i=0; i<blogTitle.length; i++) {
				for (i=0; i<blogLink.length; i++) {
					blog_plus = "<tr><td><a href='" + blogLink[i] + "' target='_blank'>"+ blogTitle[i] + "</a></td></tr>"
					document.getElementById('name_result').value = storeName
					document.getElementById('address_result').value = storeAddress
					document.getElementById('memo_result').value = storeMemo
					$('#blog_result').append(blog_plus)
				}      
			}
		})
	}
</script>
{% endblock %}

